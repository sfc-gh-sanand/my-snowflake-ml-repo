name: Snowflake Notebook Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Snowflake CLI
        run: pip install snowflake-cli-labs

      - name: Deploy Notebook to Snowflake
        env:
          SNOWFLAKE_DEFAULT_CONNECTION_NAME: deploy
          SNOWFLAKE_CONNECTIONS_DEPLOY_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_CONNECTIONS_DEPLOY_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_CONNECTIONS_DEPLOY_PASSWORD: ${{ secrets.SNOWFLAKE_PAT }}
          SNOWFLAKE_CONNECTIONS_DEPLOY_ROLE: ${{ vars.SNOWFLAKE_ROLE }}
          SNOWFLAKE_CONNECTIONS_DEPLOY_WAREHOUSE: ${{ vars.SNOWFLAKE_WAREHOUSE }}
        run: |
          # 1. Update Snowflake's internal Git mirror
          snow sql -c deploy -q "ALTER GIT REPOSITORY NPO_TEST.PUBLIC.MY_GIT_REPO FETCH"

          # 2. Deploy the Notebook object using your folder structure
          snow sql -c deploy -q "
            CREATE OR REPLACE NOTEBOOK ${{ vars.SNOWFLAKE_DATABASE }}.${{ vars.SNOWFLAKE_SCHEMA }}.ML_TRAIN_NOTEBOOK
            FROM '@NPO_TEST.PUBLIC.MY_GIT_REPO/branches/main/notebooks/ml_model/'
            MAIN_FILE = 'train.ipynb'
            QUERY_WAREHOUSE = '${{ vars.SNOWFLAKE_WAREHOUSE }}';"

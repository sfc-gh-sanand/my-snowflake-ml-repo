name: Snowflake Notebook Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows you to trigger manually with a button

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Snowflake CLI
        run: pip install snowflake-cli-labs

      - name: Deploy Notebook to Snowflake
        run: |
          # 1. Update Snowflake's internal Git mirror
          snow sql -q "ALTER GIT REPOSITORY NPO_TEST.PUBLIC.MY_GIT_REPO FETCH" \
            --account "${{ secrets.SNOWFLAKE_ACCOUNT }}" \
            --user "${{ secrets.SNOWFLAKE_USER }}" \
            --password "${{ secrets.SNOWFLAKE_PAT }}" \
            --role "${{ vars.SNOWFLAKE_ROLE }}" \
            --warehouse "${{ vars.SNOWFLAKE_WAREHOUSE }}"

          # 2. Deploy the Notebook object
          snow sql -q "
            CREATE OR REPLACE NOTEBOOK ${{ vars.SNOWFLAKE_DATABASE }}.${{ vars.SNOWFLAKE_SCHEMA }}.ML_TRAIN_NOTEBOOK
            FROM '@NPO_TEST.PUBLIC.MY_GIT_REPO/branches/main/notebooks/ml_model/'
            MAIN_FILE = 'train.ipynb'
            QUERY_WAREHOUSE = '${{ vars.SNOWFLAKE_WAREHOUSE }}';" \
            --account "${{ secrets.SNOWFLAKE_ACCOUNT }}" \
            --user "${{ secrets.SNOWFLAKE_USER }}" \
            --password "${{ secrets.SNOWFLAKE_PAT }}" \
            --role "${{ vars.SNOWFLAKE_ROLE }}" \
            --warehouse "${{ vars.SNOWFLAKE_WAREHOUSE }}"
